\documentclass{article}
\usepackage[12pt]{extsizes}
\usepackage[utf8]{inputenc}
\usepackage[T1,T2A]{fontenc}
\usepackage[english,russian]{babel}
\usepackage{setspace,amsmath}
\usepackage{enumitem}
\usepackage{etoolbox}
\usepackage[usenames, dvipsnames]{color}
\usepackage[left=30mm, top=20mm, right=20mm, bottom=20mm, footskip=10mm]{geometry}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{graphicx}
\usepackage{booktabs}
\usepackage{csquotes}
\usepackage{hyperref}
\usepackage{svg}
\usepackage{listings}
\usepackage{censor}

\usepackage[backend=biber,
    bibstyle=gost-numeric,
    citestyle=gost-numeric,
    language=english]{biblatex}

\bibliography{main.bib}

\usepackage{setspace}
\onehalfspacing

\usepackage{mathptmx}

\begin{document}
% НАЧАЛО ТИТУЛЬНОГО ЛИСТА
\begin{center}

\small{ФЕДЕРАЛЬНОЕ ГОСУДАРСТВЕННОЕ АВТОНОМНОЕ ОБРАЗОВАТЕЛЬНОЕ УЧРЕЖДЕНИЕ ВЫСШЕГО ОБРАЗОВАНИЯ}\\
\footnotesize{НАЦИОНАЛЬНЫЙ ИССЛЕДОВАТЕЛЬСКИЙ УНИВЕРСИТЕТ}\\ 
\small{\textbf{ВЫСШАЯ ШКОЛА ЭКОНОМИКИ}}\\
\hfill \break
\hfill \break
\hfill \break
\hfill \break
\hfill \break
\hfill \break
\hfill \break
\hfill \break
\hfill \break
\large{ОТЧЕТ ПО НАУЧНО-ИССЛЕДОВАТЕЛЬСКОЙ РАБОТЕ}\\
Решение проблемы фаз в кристаллографии \\
методами машинного обучения
\end{center}
\hfill \break
\hfill \break
\hfill \break
\normalsize{
\begin{tabular}{lp{6cm}l}
Студент & & \censor{Глубшев Артем Игоревич}\\\\
& & \censor{Факультет Химии}  \\\\
Группа & & \censor{БХМ192} \\\\
Научный руководитель  &  &\censor{к.х.н. Дмитриенко Артем Олегович}\\\\
\end{tabular}
}\\
\hfill \break
\hfill \break 
\hfill \break
\hfill \break
\hfill \break
\hfill \break
\begin{center} Москва 2020 \end{center}
\thispagestyle{empty}
\newpage
\tableofcontents
\newpage
\section{ВВЕДЕНИЕ}

Рентгеновская дифракция является важным методом установления строения химических веществ в кристаллах. В ходе рентгенодифракционного эксперимента через монокристалл исследуемого соединения пропускают пучок рентгеновского излучения под разными углами и фиксируют дифракционную картину, состоящую из отдельных пятен "--- отражений (рис. \ref{img:difr} - пример дифракционной картины). Кинематическая теория рассеяния рентгеновских лучей связывает каждое отражение с комплексным числом, характеризующим интенсивность и фазу дифрагированного луча "--- структурным фактором \(F_{hkl}\).

Структурные факторы можно рассчитать с помощью преобразования Фурье периодической функции электронной плотности кристалла \(\rho(\mathbf{r})\):

\[
F_{hkl} = \int_{V}\rho(x,y,z) \exp \left[ 2\pi i (hx + ky + lz)\right] dV,
\]

при этом  интенсивность отражения будет пропорциональна \(|F_{hkl}|^{2}\). Зная структурные факторы, можно восстановить функцию электронной плотности с помощью обратного  преобразования Фурье и тем самым определить структуру кристалла:

\[
  \rho(x,y,z) = \frac{1}{V_{\mbox{cell}}} \sum_{h,k,l} F_{hkl}  \exp \left[ - 2\pi i (hx + ky + lz)\right].
\]

Однако для наблюдения доступны только интенсивности отражений, фазы структурных факторов невозможно определить в эксперименте. Задача  восстановления функции электронной плотности по её Фурье-образу с утерянными фазами известна как проблема фаз.

Для произвольной функции эта задача математически неразрешима: несложно построить две разных функции, Фурье-образы которых будут отличаться только фазами. Существующие методы решения проблемы фаз так или иначе используют известные свойства функции электронной плотности "--- в первую очередь её неотрицательность и наличие в ней острых максимумов из внутренних электронов атомов.

\begin{figure}[!htp]
  \includegraphics[width=\linewidth]{imgs/difr.jpeg}
  \caption{Дифракционная картина}
  \label{img:difr}
\end{figure}

Проблема фаз является одной из центральных проблем рентгеноструктурного анализа. Существуют как экспериментальные, так и расчетные методы определения фаз рентгеновских отражений, хорошо работающие для малых молекул. Однако для крупных молекул такие методы работают плохо или не работают вообще\cite{PhaseProblem}. Также все существующие методы имеют невысокую точность и требуют участия человека в решении кристаллов, что затрудняет автоматизацию. Таким образом, задача разработки метода, способного без участия человека решать кристаллы с приемлемой точностью все еще актуальна.

\section{ОБЗОР ЛИТЕРАТУРЫ}

Машинное обучение и нейронные сети в частности помогли решить множество проблем, ранее считавшиеся крайне сложными. В частности, с помошью методов машинного обучения была решена \cite{XRD-NN} задача классификации картин порошковой рентгеновской дифракции, определения параметров кристаллической решетки\cite{MCMC}. Также машинное обучение широко применяется в науке о материалах\cite{ML-mat}.

Актуальные методы решения проблемы фаз в рентгенструктурном анализе можно разделить на три типа: методы в прямом пространстве, методы в обратном пространстве, методы в двойном пространстве\cite{XR-ED}. Рассмотрим основные методы решения проблемы фаз.

\subsection{Метод Паттерсона}

Структура малых молекул может быть решена даже при отсутствии информации о фазах. В то время как фазы определяют положения пиков электронной плотности поперек элементарной ячейки и, следовательно, положения атомов, одно только сильное дифракционное пятно дает четкое указание на то, что элементы должны присутствовать с соответствующим интервалом. Таким образом, величины структурного фактора содержат информацию о расположении атомов в структуре.

Доступ к этой информации можно получить, вычислив функцию Паттерсона\cite{PattersonMethod}. Функция Паттерсона получается путем расчета карты с использованием квадратов величин структурных факторов и всех фаз, установленных на ноль. Вместо пиков в положениях атомов карта Паттерсона показывает пики в каждой позиции, которая соответствует межатомному вектору в структуре. Функция Паттерсона была эффективным инструментом для решения проблем малых молекул; однако его полезность быстро падает с увеличением числа атомов. Для структуры из $N$ атомов функция Паттерсона будет содержать $N (N - 1)$ межатомных векторов, многие из которых перекрываются. Этот подход становится непригодным для структур из более чем 20–50 атомов, если только среди атомов в кристалле нет атомов с большим атомным номером.

\subsection{Прямые методы}

Предлагаю дописать сюда из \href{https://sci-hub.do/10.1007/0-387-33746-6}{этого} про shelxd.

В малых и средних молекулах атомы обычно хорошо упорядочены, и в результате структурные факторы удается измерить вплоть до очень высоких углов дифракции. Пятна дифракции для больших углов дают информацию о мелких деталях распределения электронной плотности в кристаллической ячейке, и в этом случае структурную информацию можно восстановить из математических соотношений между структурными факторами. Методы использующие такой подход называют прямыми методами.

Фазовые соотношения, от которых зависят прямые методы, зависят от наложения ограничений на электронную плотность в элементарной ячейке, например, что она везде положительна или что она сгруппирована в отдельные атомные пики. Если один структурный фактор известен как по величине, так и по фазе, то можно сделать вывод, что атомы с большей вероятностью будут располагаться в некоторых областях ячейки и с меньшей вероятностью - в других областях. Это накладывает ограничения на возможные фазы других структурных факторов, которые должны усиливать вероятные области, чтобы произвести острые пики в атомных положениях. Самая сильная взаимосвязь этой формы - трехфазный инвариант: в этом случае ограничения положительности и атомарности подразумевают, что, когда три отражения, сумма индексов Миллера которых равна нулю, являются сильными, фазы этих отражений должны суммироваться до значения, близкого к нулю\cite{ThreePhase}.

Дальнейший расчет с использованием прямых методов может происходить следующим образом. Фазы выбираются для нескольких сильных отражений, затем фазы для других отражений генерируются с использованием фазовых соотношений между сильными отражениями. После расчета достаточного количества фаз можно рассчитать электронную плотность и интерпретировать ее в терминах положения атомов.

К сожалению, фазовые отношения ослабевают с увеличением числа атомов в структуре; кроме того, этот подход работает только тогда, когда данные могут быть собраны с высоким разрешением. Использование методов множественного растворения, с помощью которых случайным образом выбирается больший набор начальных фаз, а расчет повторяется много раз, пока не будет получена разумная структура, позволило прямыми методами решить структуры, содержащие до 2000 атомов. Однако большинство белков не может быть решено с помощью этого подхода, потому что измерить для них структурные факторы с атомным разрешением не удается.

\subsection{Множественное изоморфное замещение}
Более крупные структуры, такие как белки, обычно менее жесткие, чем малые молекулы, и поэтому даже в кристалле между элементарными ячейками будет значительный беспорядок. Это ограничивает разрешение дифракционной картины обычно до 2 или 3 A. Поскольку эти молекулы могут также содержать многие тысячи атомов, необходимо принять другой подход к фазированию. Наиболее распространенный подход к этой проблеме - множественная изоморфная замена (MIR), предложенная в работе\cite{PERUTZ1960}.

Информация о неизвестных фазах может быть получена путем известного изменения содержимого элементарной ячейки и измерения влияния на дифракционную картину. На практике это включает введение иона тяжелого металла, в белок без нарушения структуры белка, то есть две структуры должны быть «изоморфными». Поскольку тяжелый атом рассеивает рентген сильнее, чем остальные атомы в структуре, обычно можно определить местонахождение только тяжелых атомов с помощью прямых методов или методов Паттерсона.

Как только местоположение тяжелых атомов известно, рассеяние на этих атомах можно рассчитать как по величине, так и по фазе. Дифракционные картины измеряются как для исходной струкутры так и для структуры с внедренными тяжелыми атомами, и сравниваются структурные факторы для двух кристаллов. Если структурный фактор от кристалла с тяжелым атомом значительно сильнее, чем соответствующий структурный фактор от исходного кристалла, то рассеяние на тяжелых атомах должно препятствовать рассеянию от остальной части кристалла. В этом случае (неизвестная) фаза собственного структурного фактора должна быть близка к (известной) фазе рассеяния только на тяжелом атоме.
Аналогично, если структурный фактор от кристалла с тяжелым атомом значительно слабее, чем соответствующий структурный фактор от естественного кристалла, то рассеяние от тяжелых атомов должно мешать, и фазы должны быть смещены почти на $\pi$. Однако в большинстве случаев рассеяние будет находиться между этими крайними значениями. Величина комбинированного рассеяния дает представление о величине разницы между фазой природного и тяжелого атома, но не говорит нам, опережает ли собственная фаза фазу тяжелого атома или отстает от нее. Чтобы устранить эту неоднозначность и уменьшить шум, вносимый из-за отсутствия изоморфизма между кристаллами и экспериментальной ошибки, обычно необходимо использовать несколько кристаллов с различными тяжелыми атомами, связанными с разными участками белка\cite{ProtXR}.

\subsection{Многоволновая аномальная дисперсия}

Многоволновая аномальная дисперсия стала популярной альтернативой множественному изоморфному замещению после введения экспериментов с настраиваемыми рентгеновскими лучами на синхротронах\cite{Hendrickson1997}
 Рассеяние на атоме обычно в значительной степени не зависит от длины волны; однако каждый атомный тип имеет несколько «краев поглощения», вокруг которых рассеяние быстро изменяется (по амплитуде и фазе) со средней длиной. Изменяя длину волны вокруг края поглощения для атомного типа, можно изменять вклад этих атомов в общее рассеяние.  Если положения аномально рассеивающих атомов известны  (например, в случае нескольких тяжелых атомов в структуре), информация о фазах может быть восстановлена так же как и для данных MIR\cite{Hendrickson1997}.

Аномальное рассеяние имеет еще одно важное свойство: вблизи края поглощения рассеяние на атоме сдвинуто по фазе. Обычно Фриделевские пары имеют одинаковую величину, однако при аномальном рассеянии обе фазы сдвигаются в одном направлении. Если учесть рассеяние на остальных неаномальных атомах, величины отражения и его Фриделевой пары перестают быть равными. Измерение разницы между отражениями, противоположными Фриделю, дает дополнительную информацию о фазах. Таким образом, теоретически можно получить однозначную оценку фазы структурного фактора, используя только монокристалл, путем измерения рассеяния на краю поглощения и на длине волны, удаленной от края поглощения. На практике для получения более точных оценок фазы используются несколько длин волн. Этот подход имеет несколько преимуществ перед MIR. Поскольку требуется только монокристалл, можно избежать проблем связанных с выращиванием нескольких кристаллов со связанными химически активными соединениями, как и проблемы неизоморфизма между кристаллами. 

Однако эксперимент требует очень осторожного измерения небольших различий в дифракционной картине, поэтому должен выполняться с очень высокой точностью. Кроме того, для определения местоположения всех атомов определенного типа в структуре требуется, чтобы структура содержала небольшое количество более тяжелых атомов, которые могут быть обнаружены Паттерсоном или прямыми методами.Эксперименты MAD чаще всего выполняются с использованием белка, в котором все остатки метионина были модифицированы, чтобы содержать селен вместо атома серы. Селен - умеренно эффективный аномальный рассеиватель, но по химическим свойствам очень похож на серу.

\subsection{Молекулярная замена}
Альтернативный подход к фазовой проблеме может быть использован, когда исследуемая молекула подобна другой молекуле, структура которой уже известна. В этом случае метод молекулярной замены\cite{MolReplMethod} позволяет получать фазы с известной структурой. Расчет молекулярной замены включает решение функций вращения и трансляции: известная молекула сначала вращается в трех измерениях, и для каждой ориентации структурные факторы рассчитываются на основе модели. Согласие между рассчитанными структурными факторами и наблюдаемыми значениями из дифракционного эксперимента используется для определения ориентации известной молекулы, которая наиболее точно соответствует ориентации неизвестной молекулы в кристалле. Затем ориентированная модель помещается в каждую возможную позицию в элементарной ячейке, и снова согласование структурных факторов используется для определения правильного перевода. Если правильная ориентация и перенос могут быть идентифицированы, то модель может, наконец, использоваться для расчета фаз для всех структурных факторов. Карты электронной плотности затем могут быть рассчитаны с использованием фаз из модельной структуры и взвешенных величин из неизвестной структуры. Полученную карту можно исследовать, чтобы определить неизвестную структуру.
\subsection{Итеративное улучшение фаз}
После получения экспериментальным путем оценки фаз отражений, или распределение вероятности фаз отражений, может быть рассчитана начальная карта электронной плотности. На этом этапе можно применить химические знания для улучшения карты электронной плотности и, следовательно, фаз. Поскольку молекулы белка имеют неправильную форму, они несовершенно упаковываются в кристалл. При этом пустоты заполненяются неупорядоченным растворителем. Электронная плотность в этих областях не показывает идентифицируемых пиков, поэтому карту электронной плотности можно улучшить, сгладив растворитель\cite{Wang1985}. И наоборот, заострение пиков внутри белковой области делает карту электронной плотности четче. Белки часто кристаллизуются с более чем одной копией молекулы в элементарной ячейке. Усреднение плотности между этими копиями также снижает уровень шума на карте электронной плотности. После изменения карты электронной плотности она используется для расчета нового набора структурных факторов и фаз. После объединения с наблюдаемыми значениями интенсивности структурных факторов можно рассчитать новую карту. Расчет может повторяться в течение нескольких циклов.

\subsection{Алгоритм Charge Flipping}
Итерационные алгоритмы фазирования в двойном пространстве за вызвали значительный интерес в кристаллографическом сообществе. Эти алгоритмы используют чередующиеся модификации в прямом и обратном пространстве, чтобы найти решение проблемы фаз. Среди них наиболее известен алгоритм переворота заряда (Charge Flipping Algorithm, CFA)\cite{ChargeFlipping}. 
Хотя это не первый опубликованный алгоритм такого рода, он вызвал значительный интерес к итерационным двойным пространственным методам для структурных решений и положил начало широкому интересу и развитию этой области в кристаллографии.
CFA нашел применение во многих кристаллографических задачах. Основные приложения этого алгоритма включают решение стандартных структур, решение сложных структур по данным порошковой дифракции, решение несоразмерно модулированных кристаллов и квазикристаллов, кристаллографию макромолекул\cite{Palatinus2013}.

\newpage
\section{ОСНОВНАЯ ЧАСТЬ}
Все модели обучались на суперкомпьютере НИУ ВШЭ <<Харизма>>. Для создания моделей использовался язык python и билиотеки машинного обучения Tensorflow и Keras. Все модели использовали бинарную кроссэнтропию, взвешенную по интенсивности отражения, в качестве функции ошибки и точность предсказаний в качестве метрики, если не указано иного.
  
\subsection{Получение экспериментальных данных. Создание датасета}

Экспериментальные кристаллографические данные были получены из Acta Cristallographica Section E в виде cif-файлов. Данные были обработаны с помощью python и библиотек pandas и CCTBX для получения пригодного для обучения датасета: были отобраны отражения с индексами $h,k,l \in [-10, 10]$, удалены эквивалентные отражения(для группы $P-1$ эквивалентными являются отражения удовлетворяющие условию $h_1=-h_2, k_1=-k_2, l_1=-l_2$). Размер полученного датасета составил 7000 структур - 6000 в обучающем датасете, 1000 в тестовом, по 4630 отражений в каждой. Проверка корректности расчета фаз отражений библиотекой cctbx была показана проверкой корреляции рассчетных интенсивностей с экспериментальными(рис. \ref{img:dist}). 

\begin{figure}[!htp]
  \includegraphics[width=\linewidth]{imgs/dist.png}
  \caption{Распределение реальных интенсивностей от рассчетных}
  \label{img:dist}
\end{figure}


 По итогам этой проверки стало ясно что интенсивности в файлах очень зависят от экспериментальных условий, а не только от структурных факторов - у каждого из файлов распределение $I_{exp}(I_{calc})$хорошо приближалось линейной регрессией, но коэффициенты $\frac{I_{exp}}{I_{calc}}$ сильно отличались для каждого из файлов. и чтобы исключить это влияние была необходима нормализация. Нормализация по максимуму (рис. \ref{fig:dist_max}), среднему (рис. \ref{fig:dist_mean} и медиане (рис. \ref{fig:dist_med} не дала результатов, и коэффициенты $\frac{I_{exp}}{I_{calc}}$ все так же сильно отличаются. Это может быть связано с далеким от нормального распределением значений структурных факторов.

\begin{figure}[!htp]
\includegraphics[width=\linewidth]{imgs/dist_max.png}
  \caption{нормализация по максимуму}\label{fig:dist_max}
\end{figure}

\begin{figure}[!htp]
\includegraphics[width=\linewidth]{imgs/dist_mean.png}
  \caption{нормализация по среднему значению}\label{fig:dist_mean}
\end{figure}

\begin{figure}[!htp]
\includegraphics[width=\linewidth]{imgs/dist_med.png}
  \caption{Нормализация по медиане}\label{fig:dist_med}
\end{figure}

Лучший результат был получен при использовании линейной регрессии - все данные уложились близко к одной линии, что положительно влияет на качество работы НС.

\begin{figure}[!htp]
\includegraphics[width=\linewidth]{imgs/dist_lr.jpg}
  \caption{Нормализация с помощью линейной регрессии}\label{img:dist_lr}
\end{figure}

\subsection{Обучение на экспериментальных данных}
Полученные из Acta E и обработанные данные были отправлены на С/К <<Харизма>>, было запущено обучение простейшей модели(рис. \ref{img:model1}) - полносвязного перцептрона из трех слоев, с размером слоя равным размеру входных и выходных данных.  

\begin{figure}[!htp]
\includegraphics[width=\linewidth]{imgs/placeholder.jpeg}
\caption{Архитектура простой полносвязной нейросети}
\label{img:model1}
\end{figure}

Результат обучения отрицательный - модель очень сильно переобучается, демонстрируя хорошие показатели на обучающих данных и очень плохие - на тестовых.Этот эффект наблюдается как на графике(рис. \ref{fig:acc_7k}) точности от эпохи обучения, так и на графике (рис. \ref{fig:loss_7k}) функции потерь от эпохи обучения.

\begin{figure}[!htp]
\includegraphics[width=\linewidth]{imgs/acc-7k.eps}
  \caption{Точность простой полносвязной нейросети в процессе обучения}\label{fig:acc_7k}
\end{figure}

\begin{figure}[!htp]
\includegraphics[width=\linewidth]{imgs/loss-7k.eps}
  \caption{Функция потерь простой полносвязной нейросети в процессе обучения}\label{fig:loss_7k}
\end{figure}

Из этого был сделан вывод о том, что данных для обучения модели недостаточно, и необходимо увеличить датасет. Другим возможным путем решения проблемы переобучения является снижение запоминающей способности сети путем добавления дропаутов, регуляризации, снижения количества нейронов в скрытых слоях сети и числа скрытых слоев.

\subsection{Получение данных из базы CCDC. Создание датасета}

Рассчетные данные были получены из базы данных CCDC в виде cif-файлов, обработаны идентично экспериментальным. Размер датасета составил 150 000 фалов, по 4630 отражений в каждом. Нормализация данных проводилась на максимальное значение интенсивности из присутствовавших в файле отражений. Отрицательной стороной использования данных из CCDC вместо Acta Crystallographica E стало отсутствие в этих файлах тепловых факторов - параметров тепловх колебаний молекул, что снижает качество расчета структурных факторов, а значит и параметров отражений. Другая проблема с обучением на расчетных данных - отсутствие  


\subsection{Обучение нейронной сети на данных CCDC}

Было проведено обучение нейросети на данных CCDC с разными гиперпараметрами и размером датасета. Для ускорения расчетов в части экспериментов были отброшены отражения с наибольшими индексами $h,k,l$, оставлены лишь удовлетворяющие условию $h^2+k^2+l^2<50$. После отбрасывания в каждом файле осталось по 709 отражений. Получены следующие результаты:

Для части датасета в 50 тысяч файлов, с отброшенными дальними отражениями была проведена проверка относительного качества обучения двух моделей: с одним внутренним слоем из 709 нейронов и с тремя внутренними слоями из 709 нейронов. Графики обучения (рис. \ref{fig:acc_50k}, \ref{fig:loss_50k}) демонстрируют сильное переобучение в обоих случаях, однако в случае с одним слоем оно менее выражено. Это говорит о том, что обе модели имеют избыточную запоминающую способность.

\begin{figure}[!htp]
\includegraphics[width=\linewidth]{imgs/acc-50k.eps}
  \caption{Точность нейросети с одним и тремя слоями}\label{fig:acc_50k}
\end{figure}

\begin{figure}[!htp]
\includegraphics[width=\linewidth]{imgs/loss-50k.eps}
  \caption{Функция ошибки нейросети с одним и тремя слоями}\label{fig:loss_50k}
\end{figure}

Был проверена зависимость качества обучения от размера датасета. Было проведено обучение на разном количестве данных - 7000 файлов, 50 тысяч файлов, 150 тысяч файлов, с отбросом дальних отражений. На графиках обучения(рис. \ref{fig:acc_1l_ndata}, \ref{fig:loss_1l_ndata}) видно что больший размер датасета приводит к меньшему переобучению, %ну вот кто бы мог подумать?..

\begin{figure}[!htp]
\includegraphics[width=\linewidth]{imgs/acc-1l_ndata.eps}
  \caption{Точность нейросети с одним слоем на разном количестве данных}\label{fig:acc_1l_ndata}
\end{figure}
\begin{figure}[!htp]
\includegraphics[width=\linewidth]{imgs/loss-1l_ndata.eps}
  \caption{Функция ошибки нейросети с одним слоем на разном количестве данных}\label{fig:loss_1l_ndata}
\end{figure}


Тот же результат был получен и при обучении нейросети из 3 слоев. Также было проведено обучение на 7000, 50 тысячах и 150 тысячах фалов. Заметно переобучение, оно уменьшается при увеличении размеров датасета, что можно видеть по рисункам \ref{fig:acc_3l_ndata}, \ref{fig:loss_3l_ndata}.
\begin{figure}[!htp]
\includegraphics[width=\linewidth]{imgs/acc-3l_ndata.eps}
  \caption{Точность нейросети с одним слоем на разном количестве данных}\label{fig:acc_3l_ndata}
\end{figure}

\begin{figure}[!htp]
\includegraphics[width=\linewidth]{imgs/loss-3l_ndata.eps}
  \caption{Функция ошибки нейросети с одним слоем на разном количестве данных}\label{fig:loss_3l_ndata}
\end{figure}

\subsection{Зависимость качества обучения от типа весов}

Функцю ошибки, на основе которой проводится обучение модели, можно взвесить по какой-либо характеристике, как и метрику. Была исследована зависимость качества обучения от весов применемой в модели метрики. Результаты представлены на рис. \ref{fig:acc_weight}, \ref{fig:loss_weight}

Лучший результат дает обучнение с функцией ошибки взвешенной по интенсивности отражений. Взвешивание по экспоненте от интенсивности отражений, а также отсутствие взвешивания(равный вес всех отражений) дали незначительно худшие реультаты. 

\begin{figure}[!htp]
\includegraphics[width=\linewidth]{imgs/acc-weight.eps}
  \caption{Точность нейросети в зависимости от весов функции ошибки}\label{fig:acc_weight}
\end{figure}

\begin{figure}[!htp]
\includegraphics[width=\linewidth]{imgs/loss-weight.eps}
  \caption{Функция ошибки нейросети в зависимости от весов функции ошибки}\label{fig:loss_weight}
\end{figure}

Была исследована зависимость качества обучения от размера слоя нейросети для нейросети с 1 слоем. Полученные графики обучения (рис. \ref{fig:acc_lsize}, \ref{fig:loss_lsize}) говорят о том, что при уменьшении размера слоя с одной стороны снижается степень переобучения, с другой при уменьшении размера слоя до менее чем 100 нейронов происходит заметное снижение качества обучения. Таким образом, оптимальный размер скрытого слоя нейросети вероятно составляет 100 нейронов. Этот результат заставил нас провести исследование степени сжимаемости данных с помощью автокодировщика.

\begin{figure}[!htp]
\includegraphics[width=\linewidth]{imgs/acc-lsize.eps}
  \caption{Точность нейросети в зависимости от размеров скрытого слоя}\label{fig:acc_lsize}
\end{figure}
\begin{figure}[!htp]
\includegraphics[width=\linewidth]{imgs/loss-lsize.eps}
  \caption{Функция ошибки нейросети в зависимости от размеров скрытого слоя}\label{fig:loss_lsize}
\end{figure}

Было проведено исследование взаимного влияния 

\begin{figure}[!htp]
\centering
\includegraphics[width=\linewidth]{imgs/acc-part_out.eps}
\caption{Точность нейросети в зависимости от размера вывода}
\label{fig:acc_pout}
\end{figure}


\begin{figure}[!htp]
\centering
\includegraphics[scale=0.50]{imgs/loss-part_out.eps}
\caption{Функция ошибки в зависимотси от размера вывода}
\label{fig:loss_pout}
\end{figure}


\subsection{Применение автокодировщиков для определения сжимаемости данных}

Автокодировщик - нейронная сеть, задачей которой является получить на выходном слое нейрнонов значения максимально близкие к соответствующим значениям входного слоя. При этом промежуточный слой такой нейронной сети меньше, чем входной и выходной слои. Это заставляет нейросеть анализировать закономерности данных, выделять в них паттерны, т.е. сжимать данные. Таким образом по минимальному числу нейронов в скрытом слое с которым автокодировщик будет достаточно точно восстанавливать данные можно оценить количество информации на самом деле содержащееся в данных, которое в свою очередь определяет степень возможного сжатия данных и достаточный размер скрытых слоев нейронной сети.

Были обучены автокодировщики с размером скрытого слоя 50, 100, 250, 500, 1000 нейронов. Обучение проводилось без отброса дальних отражений, т.о. размер входа нейросети составил 4630 отражений на файл. Поскольку значения выходного слоя больше не являются бинарными, вместо бинарной кросссэентропии в качестве функции ошибки была применена среднеквадратичная ошибка(MSE, mean squared error). Полученные результаты представлены на рис. \ref{fig:loss_aenc}. Видно что большее количество нейронов в скрытом слое дает большую точность, но при этом если точность при 50 и 100 нейронах в скрытом слое заметно различается, то различия точности между 500 и 1000 нейронами почти нулевое.

\begin{figure}[!htp]
\centering
\includegraphics[width=\linewidth]{imgs/loss-aenc.eps}
\caption{График обучения автоэнкодеров с разным размером скрытого слоя}
\label{fig:loss_aenc}
\end{figure}

Было проверено распределение ошибки по отражениям, результат представлен на рис. \ref{fig:aenc_errdist}, \ref{fig:aenc_errdist_fl}. Отражения на графиках отсортированы по $R=h^2+ k^2 + l^2, h,k,l$. На рис. \ref{fig:aenc_errdist_fl} применено сглаживание - показаны средние данные для окна в 50 точек. Видно что абсолютное значение среднеквадратичной ошибки выше для ближних, более интенсивных, отражений. Относительная ошибка для ближних отражений также чуть выше для малых $h,k,l$.

\begin{figure}[!htp]
\centering
\includegraphics[width=\linewidth]{imgs/aenc-errdist.eps}
\caption{Распределение ошибки по отражениям}
\label{fig:aenc_errdist}
\end{figure}


\begin{figure}[!htp]
\centering
\includegraphics[scale=0.50]{imgs/aenc-errdist_fl.eps}
\caption{распределение ошибки по отражениям}
\label{fig:aenc_errdist_fl}
\end{figure}



%TODO 2k, 3, 4k, 10, 1

%Сравнить эксп. ошибку с автоэнкодерской

%Распеделение ошибок автоэнк/эксп

%Сравнить 



\newpage
\section{РЕЗУЛЬТАТЫ И ВЫВОДЫ}

\begin{enumerate}
  \item  Создан размеченный набор данных, основанный на экспериментально измеренных интенсивностях дифракционных отражений молекулярных кристаллов с пространственной группой \(P\bar{1}\), опубликованных в журнале Acta Crystallographica Section E. Соответствующие фазы были рассчитаны с помощью библиотеки cctbx на основании опубликованных там же структурных моделей с учетом анизотропных параметров атомного смещения. Такая методология сбора данных делает набор максимально приближенным к условиям реального рентгеноструктурного анализа. Размер набора данных составил 7544 структур, 709 отражений в каждой структуре.

  \item Создан размеченный  набор данных, основанный на всех структурах с пространственной группой \(P\bar{1}\) доступных в CSD (Кембриджской базе структурных данных). И интенсивности и фазы отражений были рассчитаны с помощью библиотеки cctbx по доступным в CSD структурным моделям без учета теплового движения атомов. Размер набора данных составил 150000 структур, 709 отражений в каждой структуре.

  \item Построена серия моделей машинного обучения для решения проблемы фаз для рентгеновских отражений. Исследована зависимость качества обучения от гиперпараметров. Наиболее оптимальной оказалась модель с одним скрытым слоем из 300 нейронов, обученная на наборе расчетных данных (150 тысячах структур). Точность модели составила 51,6\% на расчетных данных и в 51.1\% на экспериментальных данных. Считается, что  для восстановления интерпретируемой электронной плотности необходимо определить фазы десяти интенсивных отражений на каждый неводородный атом в структуре [гиролами]. Исходя из этого (а также типичных для РСА размера молекулы и числа измеренных отражений) можно оценить точность современных методов решения проблемы фаз в 55\%. Таким образом, построенная модель хотя и не достигает точности конкурентов, но показывает принципиальную возможность решения проблемы фаз методами машинного обучения.

  \item Показано, что для всех исследованных моделей главным препятствием для улучшения точности становится явление переобучения. Предложены следующие гипотезы, объясняющие проблему и соответствующие им пути решения:

    \begin{itemize}
      \item В интенсивностях отражений не содержится достаточно данных для определения фаз. В этом случае помочь может добавление параметров кристаллической решетки, функции Парттерсона и других данных во входные данные нейронной сети
      \item Недостаточно данных для обучения. В этом случае решить пробему поможет увеличение размеров датасета, например с помощью OQMD или путем аугментации датасета.
      \item Нейронная сеть имеет слишком высокую запоминающую способность. В этом случае проблема может быть решена подбором оптимальной архитектуры: добавлением дропаутов, пакетных нормализаций, уменьшением размера слоев нейронной сети.
    \end{itemize}


\end{enumerate}

\newpage
\printbibliography


\end{document}
